<h1 id="overview">Overview</h1>
<p>❗❗❗ This is not a production setup, it’s only for testing and demo purpose</p>

<p>This series contain two parts, I will demonstrate different ways to collect TiDB logs for TiDB Operator deployment, using TiDB slow query log as an example.</p>
<ul>
  <li>Part I - EFK Deployment</li>
  <li>Part II - TiDB Logging Integrate with EFK</li>
</ul>

<h1 id="envrionments-used">Envrionments Used</h1>
<h2 id="part-i">Part I</h2>
<ol>
  <li>minikube v1.32.0</li>
  <li>Kubernetes v1.24</li>
  <li>ECK v2.12</li>
  <li>Elasticsearch + Kibana v8.13.0</li>
  <li>Fluentd v1.16</li>
</ol>

<h2 id="part-ii">Part II</h2>
<ol>
  <li>Fluent-bit v1.7</li>
  <li>TiDB operator v1.5.2</li>
  <li>TiDB v7.5</li>
</ol>

<h1 id="introduction">Introduction</h1>
<p>This is the Part I of the series, a simple infra level logging system setup, Fluentd as a daemonset running on each Kubernetes node as an agent to collect all containers’ logs to elasticseach. Again, this is not for production setup, just meet basic log collection requirement, production setup colud be more conprehensive.</p>

<p>efk.png</p>

<h1 id="step-by-step">Step by step</h1>
<h2 id="prepare-kubernetes">Prepare Kubernetes</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube start <span class="nt">--cpus</span><span class="o">=</span>3 <span class="nt">--memory</span><span class="o">=</span>6G <span class="nt">--disk-size</span><span class="o">=</span>25G <span class="nt">--kubernetes-version</span><span class="o">=</span>v1.24
</code></pre></div></div>

<h3 id="deploy-eck">Deploy ECK</h3>
<p>https://www.elastic.co/guide/en/cloud-on-k8s/2.12/k8s-deploy-eck.html</p>
<h4 id="11-deploy-elastic-operator">1.1 Deploy Elastic Operator</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://download.elastic.co/downloads/eck/2.12.1/crds.yaml
kubectl apply <span class="nt">-f</span> https://download.elastic.co/downloads/eck/2.12.1/operator.yaml
</code></pre></div></div>

<h4 id="12-deploy-elasticsearch">1.2 Deploy Elasticsearch</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns eck
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
  namespace: eck
spec:
  version: 8.13.0
  nodeSets:
  - name: default
    count: 1
    config:
      node.store.allow_mmap: false
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="13-deploy-kibana">1.3 Deploy Kibana</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: quickstart
  namespace: eck
spec:
  version: 8.13.0
  count: 1
  elasticsearchRef:
    name: quickstart
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="14-login-kibana">1.4 Login Kibana</h4>
<ol>
  <li>Get password
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get secret quickstart-es-elastic-user <span class="nt">-n</span> eck <span class="nt">-o</span> go-template<span class="o">=</span><span class="s1">''</span>
</code></pre></div>    </div>
  </li>
  <li>Expose kibana service access from outside Kubernetes
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward service/quickstart-kb-http <span class="nt">-n</span> eck 5601 <span class="nt">--address</span><span class="o">=</span>0.0.0.0
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="deploy-fluentd">Deploy Fluentd</h2>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#fluentd-daemonset-elasticsearch-rbac.yaml</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>

<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">fluentd-logging</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">fluentd-logging</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">fluentd-logging</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccount</span><span class="pi">:</span> <span class="s">fluentd</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">fluentd</span>
      <span class="na">tolerations</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/control-plane</span>
        <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/master</span>
        <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fluentd</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">K8S_NODE_NAME</span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">fieldRef</span><span class="pi">:</span>
                <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.nodeName</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">FLUENT_ELASTICSEARCH_HOST</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">quickstart-es-http.eck"</span> 
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span>  <span class="s">FLUENT_ELASTICSEARCH_PORT</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">9200"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FLUENT_ELASTICSEARCH_SCHEME</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https"</span>
          <span class="c1"># Option to configure elasticsearch plugin with self signed certs</span>
          <span class="c1"># ================================================================</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FLUENT_ELASTICSEARCH_SSL_VERIFY</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
          <span class="c1"># Option to configure elasticsearch plugin with tls</span>
          <span class="c1"># ================================================================</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FLUENT_ELASTICSEARCH_SSL_VERSION</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TLSv1_2"</span>
          <span class="c1"># X-Pack Authentication</span>
          <span class="c1"># =====================</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FLUENT_ELASTICSEARCH_USER</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">elastic"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FLUENT_ELASTICSEARCH_PASSWORD</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">12667swmP7CB86GFHHTVd79s"</span> <span class="c1"># replace it</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">200Mi</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">200Mi</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">varlog</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/log</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dockercontainerlogdirectory</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/docker/containers</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">30</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">varlog</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/var/log</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dockercontainerlogdirectory</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/var/lib/docker/containers</span>
</code></pre></div></div>

<h2 id="create-data-view-in-kibana">Create Data View in Kibana</h2>

<h1 id="part-ii-tidb-logging-integration">Part II: TiDB Logging Integration</h1>
<h2 id="deploy-tidb-operator">Deploy TiDB Operator</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/pingcap/tidb-operator/v1.5.2/manifests/crd.yaml
kubectl create namespace tidb-admin
helm <span class="nb">install</span> <span class="nt">--namespace</span> tidb-admin tidb-operator pingcap/tidb-operator <span class="nt">--version</span> v1.5.2
</code></pre></div></div>

<h2 id="deploy-tidb-cluster-with-basic-logging-integration">Deploy TiDB Cluster with Basic Logging Integration</h2>
<p>Since TiDB components deployed by TiDB Operator output the logs in the stdout and stderr of the container by default, all the TiDB components logs will be collected by Fluentd running on each Kubernetes node.</p>

<h3 id="11-deploy-tidb-basic-cluster">1.1 Deploy TiDB Basic Cluster</h3>
<p>1.1 Cluster manifest basic.yaml</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># basic.yaml</span>
<span class="c1"># IT IS NOT SUITABLE FOR PRODUCTION USE.</span>
<span class="c1"># This YAML describes a basic TiDB cluster with minimum resource requirements,</span>
<span class="c1"># which should be able to run in any Kubernetes cluster with storage support.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">pingcap.com/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">TidbCluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">basic</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v7.5.0</span>
  <span class="na">timezone</span><span class="pi">:</span> <span class="s">UTC</span>
  <span class="na">pvReclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">enableDynamicConfiguration</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">configUpdateStrategy</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
  <span class="na">discovery</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">helper</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">alpine:3.16.0</span>
  <span class="na">pd</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/pd</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="c1"># if storageClassName is not set, the default Storage Class of the Kubernetes cluster will be used</span>
    <span class="c1"># storageClassName: local-storage</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">tikv</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/tikv</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="c1"># If only 1 TiKV is deployed, the TiKV region leader</span>
    <span class="c1"># cannot be transferred during upgrade, so we have</span>
    <span class="c1"># to configure a short timeout</span>
    <span class="na">evictLeaderTimeout</span><span class="pi">:</span> <span class="s">1m</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="c1"># if storageClassName is not set, the default Storage Class of the Kubernetes cluster will be used</span>
    <span class="c1"># storageClassName: local-storage</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span>
        <span class="c1"># In basic examples, we set this to avoid using too much storage.</span>
        <span class="na">reserve-space</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0MB"</span>
      <span class="na">rocksdb</span><span class="pi">:</span>
        <span class="c1"># In basic examples, we set this to avoid the following error in some Kubernetes clusters:</span>
        <span class="c1"># "the maximum number of open file descriptors is too small, got 1024, expect greater or equal to 82920"</span>
        <span class="na">max-open-files</span><span class="pi">:</span> <span class="m">256</span>
      <span class="na">raftdb</span><span class="pi">:</span>
        <span class="na">max-open-files</span><span class="pi">:</span> <span class="m">256</span>
  <span class="na">tidb</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/tidb</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<h3 id="12-view-tidb-logs-in-kibana">1.2 View TiDB Logs in Kibana</h3>

<h2 id="option1-deploy-tidb-cluster-with-customized-logging-integration">Option1: Deploy TiDB Cluster with Customized Logging Integration</h2>
<p>Fluent bit running as sidecar in TiDB pod, you can use Fluentd as well. Here I choose Fluent bit as it’s light weight.</p>

<h3 id="11-prepare-fluent-bit-config">1.1 Prepare Fluent bit config</h3>
<p>For demo purpose, I will manually mount Fluent bit config. You may customize your image for a clean deployment, as slow query log is multiline format, you may need to handle it properly, mutiline format parser is skipped here</p>

<p>1.1 ConfigMap manifest tidb-fluentbit-cm.yaml</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tidb-fluentbit-cm.yaml</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">tidb-cluster</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tidb-fluentbit</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">fluent-bit.conf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[INPUT]</span>
        <span class="s">Name  tail</span>
        <span class="s">Path  /var/log/tidb/*</span>
        <span class="s">Tag   tidb</span>
        <span class="s">Read_from_Head  True</span>

    <span class="s">[OUTPUT]</span>
        <span class="s">Name  es</span>
        <span class="s">Match  *</span>
        <span class="s">Host  quickstart-es-http.eck</span>
        <span class="s">Port  9200</span>
        <span class="s">Index  tidb</span>
        <span class="s">tls  On</span>
        <span class="s">tls.verify  Off</span>
        <span class="s">HTTP_User  elastic</span>
        <span class="s">HTTP_Passwd  12667swmP7CB86GFHHTVd79s</span>
        <span class="s">Logstash_Format  On</span>
        <span class="s">Logstash_Prefix  tidb</span>
        <span class="s">Suppress_Type_Name  On</span>

    <span class="s">[OUTPUT]</span>
        <span class="s">name  stdout</span>
        <span class="s">match   *</span>
</code></pre></div></div>

<p>1.2 Create fluentbit ConfigMap</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> tidb-fluentbit-cm.yaml
</code></pre></div></div>

<h3 id="12-deploy-tidb-cluster-with-fluent-bit-as-sidecar-container">1.2 Deploy TiDB Cluster with Fluent-bit as sidecar container</h3>
<p>This deployment will keep the default slowlog container, fluent-bit as an additional container, tidb pod in total 3 containers.</p>

<p>2.1 Cluster manif advanced-cluster.yaml</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># advanced-cluster.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">pingcap.com/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">TidbCluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">advanced-test</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">tidb-cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v7.5.0"</span>
  <span class="na">timezone</span><span class="pi">:</span> <span class="s">UTC</span>
  <span class="na">configUpdateStrategy</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
  <span class="na">helper</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">alpine:3.16.0</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">pvReclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">enableDynamicConfiguration</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">pd</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/pd</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">[dashboard]</span>
        <span class="s">internal-proxy = true</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">1Gi</span>
    <span class="na">mountClusterClientSecret</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">tidb</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/tidb</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">[performance]</span>
        <span class="s">tcp-keep-alive = true</span>
      <span class="s">[log]</span>
        <span class="s">slow-threshold = 0  # for demo purpose</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
    <span class="na">additionalContainers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fluent-bit</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">fluent/fluent-bit:1.7</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">/fluent-bit/bin/fluent-bit'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">-c'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">/fluent-bit/etc/fluent-bit.conf'</span><span class="pi">]</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">slowlog</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/log/tidb</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fluent-bit-config</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/fluent-bit/etc/</span>
    <span class="na">additionalVolumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fluent-bit-config</span>
      <span class="na">configMap</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">tidb-fluentbit</span>
  <span class="na">tikv</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/tikv</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">log-level = "info"</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">5Gi</span>
    <span class="na">mountClusterClientSecret</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>2.2 Deploy cluster</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> advanced-cluster.yaml
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe po advanced-test-tidb-0 <span class="nt">-n</span> tidb-cluster
Name:             advanced-test-tidb-0
Namespace:        tidb-cluster
Priority:         0
Service Account:  default
Node:             minikube/192.168.49.2
Start Time:       Sun, 07 Apr 2024 01:17:19 +0800
Labels:           app.kubernetes.io/component<span class="o">=</span>tidb
                  app.kubernetes.io/instance<span class="o">=</span>advanced-test
                  app.kubernetes.io/managed-by<span class="o">=</span>tidb-operator
                  app.kubernetes.io/name<span class="o">=</span>tidb-cluster
                  controller-revision-hash<span class="o">=</span>advanced-test-tidb-5b4dd75db8
                  statefulset.kubernetes.io/pod-name<span class="o">=</span>advanced-test-tidb-0
                  tidb.pingcap.com/cluster-id<span class="o">=</span>7354318695080032400
Annotations:      prometheus.io/path: /metrics
                  prometheus.io/port: 10080
                  prometheus.io/scrape: <span class="nb">true
</span>Status:           Running
IP:               10.244.1.16
IPs:
  IP:           10.244.1.16
Controlled By:  StatefulSet/advanced-test-tidb
Containers:
  slowlog:
    Container ID:  docker://f08c1bec0b07f503753c09d4a9e9b8534f50597a91e3b0546e0e2e5b1674cbe3
    Image:         alpine:3.16.0
    Image ID:      docker-pullable://alpine@sha256:686d8c9dfa6f3ccfc8230bc3178d23f84eeaf7e457f36f271ab1acc53015037c
    Port:          &lt;none&gt;
    Host Port:     &lt;none&gt;
    Command:
      sh
      <span class="nt">-c</span>
      <span class="nb">touch</span> /var/log/tidb/slowlog<span class="p">;</span> <span class="nb">tail</span> <span class="nt">-n0</span> <span class="nt">-F</span> /var/log/tidb/slowlog<span class="p">;</span>
    State:          Running
      Started:      Sun, 07 Apr 2024 01:17:19 +0800
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /var/log/tidb from slowlog <span class="o">(</span>rw<span class="o">)</span>
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5f7qm <span class="o">(</span>ro<span class="o">)</span>
  tidb:
    Container ID:  docker://0c056cf2d202b9e3c8532162ab9dfc757046743a37d01c57e1d3131006ba534e
    Image:         pingcap/tidb:v7.5.0
    Image ID:      docker-pullable://pingcap/tidb@sha256:4a0f3070b27a5acf9734e16c725050ae95b4a07b58ac08693c596ce237045a1f
    Ports:         4000/TCP, 10080/TCP
    Host Ports:    0/TCP, 0/TCP
    Command:
      /bin/sh
      /usr/local/bin/tidb_start_script.sh
    State:          Running
      Started:      Sun, 07 Apr 2024 01:17:20 +0800
    Ready:          True
    Restart Count:  0
    Readiness:      tcp-socket :4000 <span class="nv">delay</span><span class="o">=</span>10s <span class="nb">timeout</span><span class="o">=</span>1s <span class="nv">period</span><span class="o">=</span>10s <span class="c">#success=1 #failure=3</span>
    Environment:
      CLUSTER_NAME:           advanced-test
      TZ:                     UTC
      BINLOG_ENABLED:         <span class="nb">false
      </span>SLOW_LOG_FILE:          /var/log/tidb/slowlog
      POD_NAME:               advanced-test-tidb-0 <span class="o">(</span>v1:metadata.name<span class="o">)</span>
      NAMESPACE:              tidb-cluster <span class="o">(</span>v1:metadata.namespace<span class="o">)</span>
      HEADLESS_SERVICE_NAME:  advanced-test-tidb-peer
    Mounts:
      /etc/podinfo from annotations <span class="o">(</span>ro<span class="o">)</span>
      /etc/tidb from config <span class="o">(</span>ro<span class="o">)</span>
      /usr/local/bin from startup-script <span class="o">(</span>ro<span class="o">)</span>
      /var/log/tidb from slowlog <span class="o">(</span>rw<span class="o">)</span>
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5f7qm <span class="o">(</span>ro<span class="o">)</span>
  fluent-bit:
    Container ID:  docker://a303e150cb6cee7a497149e8123a11917145b65ba8d9bb02ace9d5306484eee8
    Image:         fluent/fluent-bit:1.7
    Image ID:      docker-pullable://fluent/fluent-bit@sha256:c3fe3469d3bc6459e701a32d66a592cf1a88304f850ea94dfd0405dfef9152d8
    Port:          &lt;none&gt;
    Host Port:     &lt;none&gt;
    Command:
      /fluent-bit/bin/fluent-bit
      <span class="nt">-c</span>
      /fluent-bit/etc/fluent-bit.conf
    State:          Running
      Started:      Sun, 07 Apr 2024 01:17:20 +0800
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /fluent-bit/etc/ from fluent-bit-config <span class="o">(</span>rw<span class="o">)</span>
      /var/log/tidb from slowlog <span class="o">(</span>rw<span class="o">)</span>
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5f7qm <span class="o">(</span>ro<span class="o">)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  annotations:
    Type:  DownwardAPI <span class="o">(</span>a volume populated by information about the pod<span class="o">)</span>
    Items:
      metadata.annotations -&gt; annotations
  config:
    Type:      ConfigMap <span class="o">(</span>a volume populated by a ConfigMap<span class="o">)</span>
    Name:      advanced-test-tidb-6564616
    Optional:  <span class="nb">false
  </span>startup-script:
    Type:      ConfigMap <span class="o">(</span>a volume populated by a ConfigMap<span class="o">)</span>
    Name:      advanced-test-tidb-6564616
    Optional:  <span class="nb">false
  </span>slowlog:
    Type:       EmptyDir <span class="o">(</span>a temporary directory that shares a pod<span class="s1">'s lifetime)
    Medium:
    SizeLimit:  &lt;unset&gt;
  fluent-bit-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      tidb-fluentbit
    Optional:  false
  kube-api-access-5f7qm:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       &lt;nil&gt;
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              &lt;none&gt;
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  10m   default-scheduler  Successfully assigned tidb-cluster/advanced-test-tidb-0 to minikube
  Normal  Pulled     10m   kubelet            Container image "alpine:3.16.0" already present on machine
  Normal  Created    10m   kubelet            Created container slowlog
  Normal  Started    10m   kubelet            Started container slowlog
  Normal  Pulled     10m   kubelet            Container image "pingcap/tidb:v7.5.0" already present on machine
  Normal  Created    10m   kubelet            Created container tidb
  Normal  Started    10m   kubelet            Started container tidb
  Normal  Pulled     10m   kubelet            Container image "fluent/fluent-bit:1.7" already present on machine
  Normal  Created    10m   kubelet            Created container fluent-bit
  Normal  Started    10m   kubelet            Started container fluent-bit
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs advanced-test-tidb-0 <span class="nt">-c</span> fluent-bit <span class="nt">-n</span> tidb-cluster |less
</code></pre></div></div>

<h3 id="13-view-tidb-slow-query-logs-in-kibana">1.3 View TiDB Slow Query Logs in Kibana</h3>
<p>3.1 You will find tidb-yyyy.mm.dd index
3.2 Create data view for tidb index</p>
<h2 id="option2-deploy-tidb-cluster-with-customized-logging-integrationmerged">Option2: Deploy TiDB Cluster with Customized Logging Integration(Merged)</h2>
<p>We customize the default slowlog container to run Fluent bit by merging the default slowlog container and additional container.
tidb pod only 2 containers</p>

<h3 id="11-prepare-fluent-bit-config-1">1.1 Prepare Fluent bit config</h3>
<p>Same As Deploy TiDB Cluster with Customized Logging Integration</p>

<h3 id="12-deploy-tidb-cluster-with-fluent-bit-as-sidecar-container-merged-with-default-slowlog-container">1.2 Deploy TiDB Cluster with Fluent-bit as sidecar container Merged with default slowlog container</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># advanced-cluster-fluentbit-merged.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">pingcap.com/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">TidbCluster</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">advanced-test</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">tidb-cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v7.5.0"</span>
  <span class="na">timezone</span><span class="pi">:</span> <span class="s">UTC</span>
  <span class="na">configUpdateStrategy</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
  <span class="c1">#helper:</span>
  <span class="c1">#  image: alpine:3.16.0</span>
  <span class="c1">#  imagePullPolicy: IfNotPresent</span>
  <span class="na">pvReclaimPolicy</span><span class="pi">:</span> <span class="s">Retain</span>
  <span class="na">enableDynamicConfiguration</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">pd</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/pd</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">[dashboard]</span>
        <span class="s">internal-proxy = true</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">1Gi</span>
    <span class="na">mountClusterClientSecret</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">tidb</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/tidb</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">[performance]</span>
        <span class="s">tcp-keep-alive = true</span>
      <span class="s">[log]</span>
        <span class="s">slow-threshold = 0</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
    <span class="na">additionalContainers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">slowlog</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">fluent/fluent-bit:1.7</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">/fluent-bit/bin/fluent-bit'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">-c'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">/fluent-bit/etc/fluent-bit.conf'</span><span class="pi">]</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">slowlog</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/log/tidb</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fluent-bit-config</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/fluent-bit/etc/</span>
    <span class="na">additionalVolumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">fluent-bit-config</span>
      <span class="na">configMap</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">tidb-fluentbit</span>
  <span class="na">tikv</span><span class="pi">:</span>
    <span class="na">baseImage</span><span class="pi">:</span> <span class="s">pingcap/tikv</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">log-level = "info"</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxFailoverCount</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">5Gi</span>
    <span class="na">mountClusterClientSecret</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> advanced-cluster-fluentbit-merged.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ kubectl describe po advanced-test-tidb-0 -n tidb-cluster</span>
<span class="na">Name</span><span class="pi">:</span>             <span class="s">advanced-test-tidb-0</span>
<span class="na">Namespace</span><span class="pi">:</span>        <span class="s">tidb-cluster</span>
<span class="na">Priority</span><span class="pi">:</span>         <span class="m">0</span>
<span class="na">Service Account</span><span class="pi">:</span>  <span class="s">default</span>
<span class="na">Node</span><span class="pi">:</span>             <span class="s">minikube/192.168.49.2</span>
<span class="na">Start Time</span><span class="pi">:</span>       <span class="s">Sun, 07 Apr 2024 01:45:49 +0800</span>
<span class="na">Labels</span><span class="pi">:</span>           <span class="s">app.kubernetes.io/component=tidb</span>
                  <span class="s">app.kubernetes.io/instance=advanced-test</span>
                  <span class="s">app.kubernetes.io/managed-by=tidb-operator</span>
                  <span class="s">app.kubernetes.io/name=tidb-cluster</span>
                  <span class="s">controller-revision-hash=advanced-test-tidb-794cd4b948</span>
                  <span class="s">statefulset.kubernetes.io/pod-name=advanced-test-tidb-0</span>
                  <span class="s">tidb.pingcap.com/cluster-id=7354318695080032400</span>
<span class="na">Annotations</span><span class="pi">:</span>      <span class="s">prometheus.io/path</span><span class="pi">:</span> <span class="s">/metrics</span>
                  <span class="s">prometheus.io/port</span><span class="pi">:</span> <span class="m">10080</span>
                  <span class="s">prometheus.io/scrape</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">Status</span><span class="pi">:</span>           <span class="s">Running</span>
<span class="na">IP</span><span class="pi">:</span>               <span class="s">10.244.1.24</span>
<span class="na">IPs</span><span class="pi">:</span>
  <span class="na">IP</span><span class="pi">:</span>           <span class="s">10.244.1.24</span>
<span class="na">Controlled By</span><span class="pi">:</span>  <span class="s">StatefulSet/advanced-test-tidb</span>
<span class="na">Containers</span><span class="pi">:</span>
  <span class="na">slowlog</span><span class="pi">:</span>
    <span class="na">Container ID</span><span class="pi">:</span>  <span class="s">docker://9860734bc529db02e74f745281e49b566874e7a45e180c7c8141a9c18490fa16</span>
    <span class="na">Image</span><span class="pi">:</span>         <span class="s">fluent/fluent-bit:1.7</span>
    <span class="na">Image ID</span><span class="pi">:</span>      <span class="s">docker-pullable://fluent/fluent-bit@sha256:c3fe3469d3bc6459e701a32d66a592cf1a88304f850ea94dfd0405dfef9152d8</span>
    <span class="na">Port</span><span class="pi">:</span>          <span class="s">&lt;none&gt;</span>
    <span class="na">Host Port</span><span class="pi">:</span>     <span class="s">&lt;none&gt;</span>
    <span class="na">Command</span><span class="pi">:</span>
      <span class="s">/fluent-bit/bin/fluent-bit</span>
      <span class="s">-c</span>
      <span class="s">/fluent-bit/etc/fluent-bit.conf</span>
    <span class="na">State</span><span class="pi">:</span>          <span class="s">Running</span>
      <span class="s">Started</span><span class="pi">:</span>      <span class="s">Sun, 07 Apr 2024 01:45:50 +0800</span>
    <span class="na">Ready</span><span class="pi">:</span>          <span class="s">True</span>
    <span class="na">Restart Count</span><span class="pi">:</span>  <span class="m">0</span>
    <span class="na">Environment</span><span class="pi">:</span>    <span class="s">&lt;none&gt;</span>
    <span class="na">Mounts</span><span class="pi">:</span>
      <span class="s">/fluent-bit/etc/ from fluent-bit-config (rw)</span>
      <span class="s">/var/log/tidb from slowlog (rw)</span>
      <span class="s">/var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rw5bb (ro)</span>
  <span class="na">tidb</span><span class="pi">:</span>
    <span class="na">Container ID</span><span class="pi">:</span>  <span class="s">docker://ad2fd61887a0ba2482175b4cac02fe8f3f3e2459dbd124f9c30ae197213b14a9</span>
    <span class="na">Image</span><span class="pi">:</span>         <span class="s">pingcap/tidb:v7.5.0</span>
    <span class="na">Image ID</span><span class="pi">:</span>      <span class="s">docker-pullable://pingcap/tidb@sha256:4a0f3070b27a5acf9734e16c725050ae95b4a07b58ac08693c596ce237045a1f</span>
    <span class="na">Ports</span><span class="pi">:</span>         <span class="s">4000/TCP, 10080/TCP</span>
    <span class="na">Host Ports</span><span class="pi">:</span>    <span class="s">0/TCP, 0/TCP</span>
    <span class="na">Command</span><span class="pi">:</span>
      <span class="s">/bin/sh</span>
      <span class="s">/usr/local/bin/tidb_start_script.sh</span>
    <span class="na">State</span><span class="pi">:</span>          <span class="s">Running</span>
      <span class="s">Started</span><span class="pi">:</span>      <span class="s">Sun, 07 Apr 2024 01:45:50 +0800</span>
    <span class="na">Ready</span><span class="pi">:</span>          <span class="s">True</span>
    <span class="na">Restart Count</span><span class="pi">:</span>  <span class="m">0</span>
    <span class="na">Readiness</span><span class="pi">:</span>      <span class="s">tcp-socket :4000 delay=10s timeout=1s period=10s</span> <span class="c1">#success=1 #failure=3</span>
    <span class="na">Environment</span><span class="pi">:</span>
      <span class="na">CLUSTER_NAME</span><span class="pi">:</span>           <span class="s">advanced-test</span>
      <span class="na">TZ</span><span class="pi">:</span>                     <span class="s">UTC</span>
      <span class="na">BINLOG_ENABLED</span><span class="pi">:</span>         <span class="no">false</span>
      <span class="na">SLOW_LOG_FILE</span><span class="pi">:</span>          <span class="s">/var/log/tidb/slowlog</span>
      <span class="na">POD_NAME</span><span class="pi">:</span>               <span class="s">advanced-test-tidb-0 (v1:metadata.name)</span>
      <span class="na">NAMESPACE</span><span class="pi">:</span>              <span class="s">tidb-cluster (v1:metadata.namespace)</span>
      <span class="na">HEADLESS_SERVICE_NAME</span><span class="pi">:</span>  <span class="s">advanced-test-tidb-peer</span>
    <span class="na">Mounts</span><span class="pi">:</span>
      <span class="s">/etc/podinfo from annotations (ro)</span>
      <span class="s">/etc/tidb from config (ro)</span>
      <span class="s">/usr/local/bin from startup-script (ro)</span>
      <span class="s">/var/log/tidb from slowlog (rw)</span>
      <span class="s">/var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rw5bb (ro)</span>
<span class="na">Conditions</span><span class="pi">:</span>
  <span class="s">Type              Status</span>
  <span class="s">Initialized       True</span>
  <span class="s">Ready             True</span>
  <span class="s">ContainersReady   True</span>
  <span class="s">PodScheduled      True</span>
<span class="na">Volumes</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span>  <span class="s">DownwardAPI (a volume populated by information about the pod)</span>
    <span class="na">Items</span><span class="pi">:</span>
      <span class="s">metadata.annotations -&gt; annotations</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span>      <span class="s">ConfigMap (a volume populated by a ConfigMap)</span>
    <span class="na">Name</span><span class="pi">:</span>      <span class="s">advanced-test-tidb-6564616</span>
    <span class="na">Optional</span><span class="pi">:</span>  <span class="no">false</span>
  <span class="na">startup-script</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span>      <span class="s">ConfigMap (a volume populated by a ConfigMap)</span>
    <span class="na">Name</span><span class="pi">:</span>      <span class="s">advanced-test-tidb-6564616</span>
    <span class="na">Optional</span><span class="pi">:</span>  <span class="no">false</span>
  <span class="na">slowlog</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span>       <span class="s">EmptyDir (a temporary directory that shares a pod's lifetime)</span>
    <span class="na">Medium</span><span class="pi">:</span>
    <span class="na">SizeLimit</span><span class="pi">:</span>  <span class="s">&lt;unset&gt;</span>
  <span class="na">fluent-bit-config</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span>      <span class="s">ConfigMap (a volume populated by a ConfigMap)</span>
    <span class="na">Name</span><span class="pi">:</span>      <span class="s">tidb-fluentbit</span>
    <span class="na">Optional</span><span class="pi">:</span>  <span class="no">false</span>
  <span class="na">kube-api-access-rw5bb</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span>                    <span class="s">Projected (a volume that contains injected data from multiple sources)</span>
    <span class="na">TokenExpirationSeconds</span><span class="pi">:</span>  <span class="m">3607</span>
    <span class="na">ConfigMapName</span><span class="pi">:</span>           <span class="s">kube-root-ca.crt</span>
    <span class="na">ConfigMapOptional</span><span class="pi">:</span>       <span class="s">&lt;nil&gt;</span>
    <span class="na">DownwardAPI</span><span class="pi">:</span>             <span class="no">true</span>
<span class="na">QoS Class</span><span class="pi">:</span>                   <span class="s">BestEffort</span>
<span class="na">Node-Selectors</span><span class="pi">:</span>              <span class="s">&lt;none&gt;</span>
<span class="na">Tolerations</span><span class="pi">:</span>                 <span class="s">node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span>
                             <span class="s">node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span>
<span class="na">Events</span><span class="pi">:</span>
  <span class="s">Type    Reason     Age    From               Message</span>
  <span class="s">----    ------     ----   ----               -------</span>
  <span class="s">Normal  Scheduled  4m30s  default-scheduler  Successfully assigned tidb-cluster/advanced-test-tidb-0 to minikube</span>
  <span class="s">Normal  Pulled     4m29s  kubelet            Container image "fluent/fluent-bit:1.7" already present on machine</span>
  <span class="s">Normal  Created    4m29s  kubelet            Created container slowlog</span>
  <span class="s">Normal  Started    4m29s  kubelet            Started container slowlog</span>
  <span class="s">Normal  Pulled     4m29s  kubelet            Container image "pingcap/tidb:v7.5.0" already present on machine</span>
  <span class="s">Normal  Created    4m29s  kubelet            Created container tidb</span>
  <span class="s">Normal  Started    4m29s  kubelet            Started container tidb</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl logs advanced-test-tidb-0 <span class="nt">-c</span> slowlog <span class="nt">-n</span> tidb-cluster |less
</code></pre></div></div>

<h3 id="13-view-tidb-slow-query-logs-in-kibana-1">1.3 View TiDB Slow Query Logs in Kibana</h3>

<h1 id="appendix">Appendix</h1>
<h2 id="1-fluent-bit-multiline-parser-for-slowlog-configmap">1. Fluent-bit Multiline Parser for slowlog configmap</h2>
<p>Require at least fluent-bit v1.8</p>

<p>tidb-fluentbit-cm-slowlog.yaml</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">tidb-cluster</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tidb-fluentbit</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">fluent-bit.conf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[SERVICE]</span>
        <span class="s">flush        1</span>
        <span class="s">Daemon       off</span>
        <span class="s">log_level    trace</span>
        <span class="s">parsers_file parsers_multiline.conf</span>

    <span class="s">[INPUT]</span>
        <span class="s">Name  tail</span>
        <span class="s">Path  /var/log/tidb/*</span>
        <span class="s">Tag   tidb</span>
        <span class="s">Read_from_Head  True</span>
        <span class="s">multiline.parser multiline-regex-slowlog</span>

    <span class="s">[FILTER]</span>
        <span class="s">Name record_modifier</span>
        <span class="s">Match *</span>
        <span class="s">Record pod ${HOSTNAME}</span>
        <span class="s">Record tidb ${ADVANCED_TEST_TIDB_PORT_10080_TCP}</span>

    <span class="s">[OUTPUT]</span>
        <span class="s">Name  es</span>
        <span class="s">Match  *</span>
        <span class="s">Host  quickstart-es-http.eck</span>
        <span class="s">Port  9200</span>
        <span class="s">Index  tidb</span>
        <span class="s">tls  On</span>
        <span class="s">tls.verify  Off</span>
        <span class="s">HTTP_User  elastic</span>
        <span class="s">HTTP_Passwd  12667swmP7CB86GFHHTVd79s</span>
        <span class="s">Logstash_Format  On</span>
        <span class="s">Logstash_Prefix  tidb</span>
        <span class="s">Suppress_Type_Name  On</span>

    <span class="s">[OUTPUT]</span>
        <span class="s">name  stdout</span>
        <span class="s">match   *</span>

  <span class="s">parsers_multiline.conf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">[MULTILINE_PARSER]</span>
        <span class="s">name          multiline-regex-slowlog</span>
        <span class="s">type          regex</span>
        <span class="s">flush_timeout 1000</span>
        <span class="s"># Regex rules for multiline parsing</span>
        <span class="s"># ---------------------------------</span>
        <span class="s">#</span>
        <span class="s"># configuration hints:</span>
        <span class="s">#</span>
        <span class="s">#  - first state always has the name: start_state</span>
        <span class="s">#  - every field in the rule must be inside double quotes</span>
        <span class="s">#</span>
        <span class="s"># rules   |   state name   | regex pattern                                    | next state name</span>
        <span class="s"># --------|----------------|--------------------------------------------------|----------------</span>
        <span class="s">rule         "start_state"   "/# Time: \d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.*/"  "cont"</span>
        <span class="s">rule         "cont"          "/# (?!Time: )/"                                   "cont"</span>
        <span class="s">rule         "cont"          "/^(?!#)/"                                         "cont"</span>
</code></pre></div></div>

<p>Kinbana example</p>

