<p>❗ This is not a production setup, it’s only for testing and demo purpose</p>

<p>This series contain two parts, I will demonstrate different ways to collect TiDB logs for TiDB Operator deployment, using TiDB slow query log as an example.</p>

<h3 id="envrionments-used">Envrionments Used</h3>
<h4 id="part-i---efk-deployment">Part I - EFK Deployment</h4>
<ol>
  <li>minikube v1.32.0</li>
  <li>Kubernetes v1.24</li>
  <li>ECK v2.12</li>
  <li>Elasticsearch + Kibana v8.13.0</li>
  <li>Fluentd v1.16</li>
</ol>

<h4 id="part-ii---tidb-logging-integrate-with-efk">Part II - TiDB Logging Integrate with EFK</h4>
<ol>
  <li>Fluent-bit v1.7</li>
  <li>TiDB operator v1.5.2</li>
  <li>TiDB v7.5</li>
</ol>

<h3 id="introduction">Introduction</h3>
<p>This is the Part I of the series, a simple infra level logging system setup, Fluentd as a daemonset running on each Kubernetes node as an agent to collect all containers’ logs to elasticseach. Again, this is not for production setup, just meet basic log collection requirement, production setup colud be more conprehensive.</p>

<figure>
	<img src="http://localhost:4000/images/efk.png" alt="efk" />
	<figcaption>A glance of the architecture</figcaption>
</figure>

<h3 id="step-by-step-setup">Step By Step Setup</h3>
<h4 id="1-prepare-kubernetes">1. Prepare Kubernetes</h4>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube start <span class="nt">--cpus</span><span class="o">=</span>3 <span class="nt">--memory</span><span class="o">=</span>6G <span class="nt">--disk-size</span><span class="o">=</span>25G <span class="nt">--kubernetes-version</span><span class="o">=</span>v1.24
</code></pre></div></div>
<h4 id="2-deploy-eck">2. Deploy ECK</h4>
<p>Refer to official documentation  <a href="https://www.elastic.co/guide/en/cloud-on-k8s/2.12/k8s-deploy-eck.html">https://www.elastic.co/guide/en/cloud-on-k8s/2.12/k8s-deploy-eck.html</a></p>
<h5 id="21-deploy-elastic-operator">2.1 Deploy Elastic Operator</h5>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://download.elastic.co/downloads/eck/2.12.1/crds.yaml
kubectl apply <span class="nt">-f</span> https://download.elastic.co/downloads/eck/2.12.1/operator.yaml
</code></pre></div></div>

<figure>
        <img src="http://localhost:4000/images/es-operator.png" alt="es-operator" width="900" />
</figure>

<h5 id="22-deploy-elasticsearch">2.2 Deploy Elasticsearch</h5>
<ol>
  <li>Create namespace for ECK
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns eck
</code></pre></div>    </div>
  </li>
  <li>Deploy Elaisticsearch
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
  namespace: eck
spec:
  version: 8.13.0
  nodeSets:
  - name: default
 count: 1
 config:
   node.store.allow_mmap: false
</span><span class="no">EOF
</span></code></pre></div>    </div>
  </li>
</ol>
<figure>
        <img src="http://localhost:4000/images/es.png" alt="es" width="900" />
</figure>
<blockquote>
  <p>Make sure HEALTH is green, and PHASE is ready.</p>
  <h5 id="23-deploy-kibana">2.3 Deploy Kibana</h5>
  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: quickstart
  namespace: eck
spec:
  version: 8.13.0
  count: 1
  elasticsearchRef:
    name: quickstart
</span><span class="no">EOF
</span></code></pre></div>  </div>
  <h5 id="24-login-kibana">2.4 Login Kibana</h5>
  <ol>
    <li>Get password
      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get secret quickstart-es-elastic-user <span class="nt">-n</span> eck <span class="nt">-o</span> go-template<span class="o">=</span><span class="s1">''</span>
</code></pre></div>      </div>
    </li>
    <li>Expose kibana service access from outside Kubernetes
      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward service/quickstart-kb-http <span class="nt">-n</span> eck 5601 <span class="nt">--address</span><span class="o">=</span>0.0.0.0
</code></pre></div>      </div>
      <h4 id="3-deploy-fluentd">3. Deploy Fluentd</h4>
      <p>Prepare fluentd-daemonset-elasticsearch-rbac.yaml
```plaintext
#fluentd-daemonset-elasticsearch-rbac.yaml
—
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluentd
  namespace: kube-system</p>
    </li>
  </ol>
</blockquote>

<hr />
<p>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluentd
rules:</p>
<ul>
  <li>apiGroups:
    <ul>
      <li>””
resources:</li>
      <li>pods</li>
      <li>namespaces
verbs:</li>
      <li>get</li>
      <li>list</li>
      <li>watch</li>
    </ul>
  </li>
</ul>

<hr />
<p>kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: fluentd
roleRef:
  kind: ClusterRole
  name: fluentd
  apiGroup: rbac.authorization.k8s.io
subjects:</p>
<ul>
  <li>kind: ServiceAccount
name: fluentd
namespace: kube-system
—
apiVersion: apps/v1
kind: DaemonSet
metadata:
name: fluentd
namespace: kube-system
labels:
  k8s-app: fluentd-logging
  version: v1
spec:
selector:
  matchLabels:
    k8s-app: fluentd-logging
    version: v1
template:
  metadata:
    labels:
      k8s-app: fluentd-logging
      version: v1
  spec:
    serviceAccount: fluentd
    serviceAccountName: fluentd
    tolerations:
    - key: node-role.kubernetes.io/control-plane
      effect: NoSchedule
    - key: node-role.kubernetes.io/master
      effect: NoSchedule
    containers:
    - name: fluentd
      image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
      env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name:  FLUENT_ELASTICSEARCH_HOST
          value: “quickstart-es-http.eck” 
        - name:  FLUENT_ELASTICSEARCH_PORT
          value: “9200”
        - name: FLUENT_ELASTICSEARCH_SCHEME
          value: “https”
        # Option to configure elasticsearch plugin with self signed certs
        # ================================================================
        - name: FLUENT_ELASTICSEARCH_SSL_VERIFY
          value: “false”
        # Option to configure elasticsearch plugin with tls
        # ================================================================
        - name: FLUENT_ELASTICSEARCH_SSL_VERSION
          value: “TLSv1_2”
        # X-Pack Authentication
        # =====================
        - name: FLUENT_ELASTICSEARCH_USER
          value: “elastic”
        - name: FLUENT_ELASTICSEARCH_PASSWORD
          value: “12667swmP7CB86GFHHTVd79s” # replace it
      resources:
        limits:
          memory: 200Mi
        requests:
          cpu: 100m
          memory: 200Mi
      volumeMounts:
      - name: varlog
        mountPath: /var/log
      - name: dockercontainerlogdirectory
        mountPath: /var/lib/docker/containers
        readOnly: true
    terminationGracePeriodSeconds: 30
    volumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: dockercontainerlogdirectory
      hostPath:
        path: /var/lib/docker/containers
```
    <h4 id="4-create-data-view-in-kibana">4. Create Data View in Kibana</h4>
  </li>
</ul>
