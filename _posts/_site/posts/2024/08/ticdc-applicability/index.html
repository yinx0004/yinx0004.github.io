<p>This article focuses on the more <strong>difficult to determine</strong> parts of the TiCDC’s limitations.</p>

<p>Currently, TiCDC unsupported scenarios and limitations as below:</p>
<ul>
  <li>A TiKV cluster that uses RawKV alone.</li>
  <li>The CREATE SEQUENCE DDL operation and the SEQUENCE function in TiDB. When the upstream TiDB uses SEQUENCE, TiCDC ignores SEQUENCE DDL operations/functions performed upstream. However, DML operations using SEQUENCE functions can be correctly replicated.</li>
  <li>Currently, performing BR data recovery and TiDB Lightning physical import imports on tables and databases that are being replicated by TiCDC is not supported. For more information, see Why does replication using TiCDC stall or even stop after data restore using TiDB Lightning and BR from upstream.</li>
  <li>TiCDC only replicates tables that have at least one valid index</li>
</ul>

<p>For details, refer to the official documentation <a href="https://docs.pingcap.com/tidb/stable/ticdc-overview#unsupported-scenarios">unsupported scenarios</a> and <a href="https://docs.pingcap.com/tidb/stable/ticdc-overview#best-practices">best practices</a>.</p>

<p>The most difficult part of these limitations to be identified is <strong>the valid index</strong>:</p>
<blockquote>
  <p>TiCDC only replicates tables that have at least one valid index. A valid index is defined as follows:</p>

  <p>A primary key (PRIMARY KEY) is a valid index.</p>

  <p>A unique index (UNIQUE INDEX) is valid if every column of the index is explicitly defined as non-nullable (NOT NULL) and the index does not have a virtual generated column (VIRTUAL GENERATED COLUMNS).</p>
</blockquote>

<p>If there are tables in the TiDB cluster without at least one valid index, then these tables cannot use TiCDC to synchronize data. How to find out which tables in the cluster do not have any valid index?</p>

<p>1.Find tables that have primary key</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">=</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">);</span>
</code></pre></div></div>

<p>2.Find tables have unique index and every column of the index is explicitly defined as non-nullable (NOT NULL) and the index does not have a virtual generated column</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">&lt;&gt;</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">NON_UNIQUE</span><span class="o">=</span><span class="mi">0</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">a</span> <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span><span class="k">TABLE_NAME</span><span class="p">,</span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="n">IS_NULLABLE</span><span class="p">,</span><span class="n">GENERATION_EXPRESSION</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">table_name</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">column_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">column_name</span> <span class="k">where</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">IS_NULLABLE</span><span class="o">=</span><span class="s1">'NO'</span> <span class="k">and</span> <span class="n">b</span><span class="p">.</span><span class="n">GENERATION_EXPRESSION</span><span class="o">=</span><span class="s1">''</span><span class="p">);</span>
</code></pre></div></div>

<p>3.Combine the result of the above two sets are the tables have valid index</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">=</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">)</span>
<span class="k">union</span> <span class="k">all</span>
<span class="k">select</span> <span class="k">distinct</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">&lt;&gt;</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">NON_UNIQUE</span><span class="o">=</span><span class="mi">0</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">a</span> <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span><span class="k">TABLE_NAME</span><span class="p">,</span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="n">IS_NULLABLE</span><span class="p">,</span><span class="n">GENERATION_EXPRESSION</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">table_name</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">column_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">column_name</span> <span class="k">where</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">IS_NULLABLE</span><span class="o">=</span><span class="s1">'NO'</span> <span class="k">and</span> <span class="n">b</span><span class="p">.</span><span class="n">GENERATION_EXPRESSION</span><span class="o">=</span><span class="s1">''</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p><code class="language-plaintext highlighter-rouge">Tables Without Valid Index</code> = <code class="language-plaintext highlighter-rouge">All Tables</code> - <code class="language-plaintext highlighter-rouge">Tables With Valid Index</code>, if the result set of the follow SQL is not empty, means the TiDB cluster contains tables can not be replicated by TiCDC.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span> <span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">)</span> <span class="k">and</span> <span class="n">table_type</span><span class="o">=</span><span class="s1">'BASE TABLE'</span> <span class="k">and</span> <span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="k">table_name</span><span class="p">)</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="k">distinct</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">=</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">)</span> <span class="k">union</span> <span class="k">all</span> <span class="k">select</span> <span class="k">distinct</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">&lt;&gt;</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">NON_UNIQUE</span><span class="o">=</span><span class="mi">0</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">a</span> <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span><span class="k">TABLE_NAME</span><span class="p">,</span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="n">IS_NULLABLE</span><span class="p">,</span><span class="n">GENERATION_EXPRESSION</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">table_name</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">column_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">column_name</span> <span class="k">where</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">IS_NULLABLE</span><span class="o">=</span><span class="s1">'NO'</span> <span class="k">and</span> <span class="n">b</span><span class="p">.</span><span class="n">GENERATION_EXPRESSION</span><span class="o">=</span><span class="s1">''</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="others">Others</h3>
<p>About another limitation not supporting SEQUENCE related operations. It is very simple to find out whether SEQUENCE is used in the cluster. The SQL is as follows. If the query result is not empty, it means that SEQUENCE is used:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">table_schema</span><span class="p">,</span> <span class="k">table_name</span><span class="p">,</span> <span class="n">table_type</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span> <span class="k">where</span> <span class="n">table_type</span><span class="o">=</span><span class="s1">'SEQUENCE'</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<p> 
 
 
 </p>

<h2 id="中文版">中文版</h2>
<p>本文主要围绕 TiCDC 的限制中比较<strong>难确定</strong>的部分内容，TiCDC 官方文档中已经清楚的描述了不支持的场景以及必须满足的条件。</p>

<p>目前 TiCDC 暂不支持的场景和限制如下：</p>
<ul>
  <li>暂不支持单独使用 RawKV 的 TiKV 集群。</li>
  <li>暂不支持在 TiDB 中创建 SEQUENCE 的 DDL 操作和 SEQUENCE 函数。在上游 TiDB 使用 SEQUENCE 时，TiCDC 将会忽略掉上游执行的 SEQUENCE DDL 操作/函数，但是使用 SEQUENCE 函数的 DML 操作可以正确地同步。</li>
  <li>暂不支持在同步的过程中对 TiCDC 正在同步的表和库进行 BR 数据恢复 和 TiDB Lightning 物理导入。详情请参考为什么在上游使用了 TiDB Lightning 和 BR 恢复了数据之后，TiCDC 同步会出现卡顿甚至卡住。</li>
  <li>TiCDC 同步的表需要至少存在一个有效索引的表。</li>
</ul>

<p>详见<a href="https://docs.pingcap.com/tidb/stable/ticdc-overview#ticdc-overview">官方文档</a> 中 <a href="https://docs.pingcap.com/tidb/stable/ticdc-overview#unsupported-scenarios">暂不支持的场景</a>  和 <a href="https://docs.pingcap.com/tidb/stable/ticdc-overview#best-practices">最佳实践</a>。</p>

<p>这些限制中最不好判断的是<strong>有效索引</strong>这一条：</p>
<blockquote>
  <p>TiCDC同步的表需要至少存在一个有效索引的表，有效索引的定义如下：</p>

  <p>主键 (PRIMARY KEY) 为有效索引。</p>

  <p>唯一索引 (UNIQUE INDEX) 中每一列在表结构中明确定义非空 (NOT NULL) 且不存在虚拟生成列 (VIRTUAL GENERATED COLUMNS)。</p>
</blockquote>

<p>如果 TiDB 集群中有表没有有效索引，那么这些表是不能利用 TiCDC 来同步数据的，如何集群中哪些表没有有效索引呢？推导如下：</p>

<p>1.找出有主键的表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">=</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">);</span>
</code></pre></div></div>

<p>2.找出有唯一索引并且索引中每一列在表结构中明确定义非空 (NOT NULL) 且不存在虚拟生成列的表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">&lt;&gt;</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">NON_UNIQUE</span><span class="o">=</span><span class="mi">0</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">a</span> <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span><span class="k">TABLE_NAME</span><span class="p">,</span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="n">IS_NULLABLE</span><span class="p">,</span><span class="n">GENERATION_EXPRESSION</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">table_name</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">column_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">column_name</span> <span class="k">where</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">IS_NULLABLE</span><span class="o">=</span><span class="s1">'NO'</span> <span class="k">and</span> <span class="n">b</span><span class="p">.</span><span class="n">GENERATION_EXPRESSION</span><span class="o">=</span><span class="s1">''</span><span class="p">);</span>
</code></pre></div></div>

<p>3.以上两种表的并集就是含有有效索引的表。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">=</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">)</span> 
<span class="k">union</span> <span class="k">all</span> 
<span class="k">select</span> <span class="k">distinct</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">&lt;&gt;</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">NON_UNIQUE</span><span class="o">=</span><span class="mi">0</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">a</span> <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span><span class="k">TABLE_NAME</span><span class="p">,</span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="n">IS_NULLABLE</span><span class="p">,</span><span class="n">GENERATION_EXPRESSION</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">table_name</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">column_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">column_name</span> <span class="k">where</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">IS_NULLABLE</span><span class="o">=</span><span class="s1">'NO'</span> <span class="k">and</span> <span class="n">b</span><span class="p">.</span><span class="n">GENERATION_EXPRESSION</span><span class="o">=</span><span class="s1">''</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="总结">总结</h3>
<p>最后从所有表中排除含有有效索引的表就是我们需要的没有有效索引的表的集合，如果以下 SQL 的查询结果为非空，则表示 TiDB 集群中包含有不能使用 TiCDC 来同步数据的表：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span> <span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">)</span> <span class="k">and</span> <span class="n">table_type</span><span class="o">=</span><span class="s1">'BASE TABLE'</span> <span class="k">and</span> <span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="k">table_name</span><span class="p">)</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="k">distinct</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">=</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">)</span> <span class="k">union</span> <span class="k">all</span> <span class="k">select</span> <span class="k">distinct</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tidb_indexes</span> <span class="k">where</span> <span class="n">KEY_NAME</span><span class="o">&lt;&gt;</span><span class="s1">'PRIMARY'</span> <span class="k">and</span> <span class="n">NON_UNIQUE</span><span class="o">=</span><span class="mi">0</span> <span class="k">and</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">a</span> <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span><span class="k">TABLE_NAME</span><span class="p">,</span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="n">IS_NULLABLE</span><span class="p">,</span><span class="n">GENERATION_EXPRESSION</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">where</span> <span class="n">table_schema</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'METRICS_SCHEMA'</span><span class="p">,</span><span class="s1">'mysql'</span><span class="p">,</span><span class="s1">'PERFORMANCE_SCHEMA'</span><span class="p">,</span><span class="s1">'INFORMATION_SCHEMA'</span><span class="p">,</span><span class="s1">'sys'</span><span class="p">))</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">table_schema</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">table_schema</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">table_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">table_name</span> <span class="k">and</span> <span class="n">a</span><span class="p">.</span><span class="k">column_name</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="k">column_name</span> <span class="k">where</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">IS_NULLABLE</span><span class="o">=</span><span class="s1">'NO'</span> <span class="k">and</span> <span class="n">b</span><span class="p">.</span><span class="n">GENERATION_EXPRESSION</span><span class="o">=</span><span class="s1">''</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="其他">其他</h3>
<p>还有一个关于不支持 SEQUENCE 相关操作的限制，找出集群中是否使用了 SEQUENCE 是很简单的，SQL 如下，如果查询结果为非空，则说明使用了 SEQUENCE：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">table_schema</span><span class="p">,</span> <span class="k">table_name</span><span class="p">,</span> <span class="n">table_type</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span> <span class="k">where</span> <span class="n">table_type</span><span class="o">=</span><span class="s1">'SEQUENCE'</span><span class="p">;</span>
</code></pre></div></div>
